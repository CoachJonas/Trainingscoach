<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Trainingscoach – V13.4</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1020">
<style>
:root{--bg:#0b1020;--card:#0f1a32;--text:#e9eef7;--mut:#93a3b8;--acc:#60a5fa;--ok:#22c55e}
*{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1730);color:var(--text)}
.wrap{max-width:880px;margin:0 auto;padding:16px}
h1{margin:0 0 10px;font-size:22px}
.card{background:var(--card);border:1px solid #1c2a45;border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 6px 22px rgba(0,0,0,.25)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{background:#132240;border:1px solid #263b67;color:#e9eef7;border-radius:10px;padding:10px 12px;cursor:pointer}
.btn.acc{background:var(--acc);border:none;color:#0b1020;font-weight:700}
select,input[type=date],input[type=number],input[type=text]{background:#0f1b33;border:1px solid #203357;color:var(--text);border-radius:10px;padding:10px}
.small{color:var(--mut);font-size:12px}
.exercise{border:1px dashed #25406e;border-radius:12px;padding:10px;margin-top:10px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.badge{display:inline-block;padding:3px 10px;border-radius:999px;background:#132240;border:1px solid #22365d;color:#bcd1f5;font-size:12px;margin-left:6px}
.noteinput{width:100%;margin-top:8px}
.sep{height:1px;background:#1c2a45;margin:12px 0}
footer{padding:16px;color:#7f8ea6;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>Trainingscoach – <span class="badge">V13.4</span></h1>

  <div class="card">
    <div class="row">
      <button id="btnBackup" class="btn">Backup-Text einfügen</button>
      <button id="btnCSV" class="btn">CSV Export</button>
      <button id="btnInstall" class="btn">Zum Home-Bildschirm (Hinweis)</button>
      <span class="small">Offline-fähig · Daten bleiben lokal</span>
    </div>
  </div>

  <div class="card">
    <div class="small">Empfehlung: Pull ≤72 h, Push/Beine ≤96 h; sonst Zyklus. Nachtschicht: Ober/Unter im Wechsel.</div>
    <div class="row" style="margin-top:8px">
      <label class="small"><input type="checkbox" id="isNight" style="margin-right:6px"> Nachtschicht heute?</label>
      <input type="date" id="datePick">
      <button id="btnRecommend" class="btn">Empfehlung anzeigen</button>
      <div id="rec" class="small" style="margin-left:auto">—</div>
    </div>
  </div>

  <div class="card">
    <div class="small">Heutige Einheit</div>
    <div class="row">
      <select id="session"></select>
      <button id="load" class="btn acc">Plan laden</button>
    </div>
    <div id="list"></div>
  </div>

  <div class="card">
    <div class="small">Add-On Übung (max. 2 pro Tag)</div>
    <div class="row">
      <select id="addonSel"></select>
      <button id="addAddon" class="btn">+ hinzufügen</button>
    </div>
    <div id="addons" class="small">—</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="clearToday" class="btn">Heutige Einheit leeren</button>
    </div>
    <div id="status" class="small">—</div>
  </div>
</div>
<footer>© Coach – V13.4</footer>

<script>
const STORE_KEY="coach_v13_4";
const STATE=loadState();

const SESSIONS={
  free_pull:{name:"Freie Tage – Pull",ex:[["pullup_wide","Klimmzüge breit",4,[6,6,10]],["row_tbar","Rudern LH/T-Bar",4,[6,6,10]],["lat_narrow","Latzug eng",3,[8,10,12]],["rdl_pull","Gestrecktes KH",4,[6,6,10]],["shrugs","Shrugs",3,[10,10,12]],["curl_bi","Bizepscurls",3,[8,10,12]],["curl_hammer","Hammercurls",3,[8,10,12]] ]},
  free_push:{name:"Freie Tage – Push",ex:[["bench","Flachbankdrücken LH",4,[6,8,10]],["incline_db","Schrägbankdrücken KH",4,[6,8,10]],["dips","Dips",3,[8,10,12]],["ohp","Schulterdrücken",3,[6,8,10]],["laterals","Seitheben",3,[12,12,15]],["revfly","Reverse Flys",3,[12,12,15]],["tri_push","Trizepsdrücken",3,[8,10,12]] ]},
  free_legs:{name:"Freie Tage – Beine",ex:[["squat_press","Kniebeugen/Beinpresse",4,[6,8,10]],["frontsquat","Frontkniebeugen",3,[8,8,12]],["legext","Beinstrecker",3,[12,12,15]],["legcurl","Beinbeuger",3,[12,12,15]],["calf_stand","Waden stehend",4,[12,15,20]],["calf_sit","Waden sitzend",4,[12,15,20]] ]},
  free_weak:{name:"Freie Tage – Schwachstellen",ex:[["incline_db_sw","Schrägbankdrücken KH",4,[6,8,10]],["pecdeck","Butterfly/Kabel",3,[12,12,15]],["row_onearm","Rudern einarmig KH",3,[8,10,12]],["pullup_neutral","Klimmzüge neutral",3,[6,8,10]],["ohp_machine","Schulterdrücken Maschine",3,[6,8,10]],["laterals_drop","Seitheben Drop-Set",3,[12,12,15]],["facepull_revfly","Face Pulls/Reverse Flys",3,[12,12,15]],["sup_bi_tri","Bizeps+Trizeps Superset",3,[10,10,12]] ]},
  night_upper:{name:"Nachtschicht – Oberkörper (35 Min)",ex:[["night_incline_db","Schrägbankdrücken KH",3,[6,8,10]],["night_pullup","Klimmzüge/Latzug",3,[6,8,10]],["night_row_low","Rudern Low Row",3,[6,8,10]],["night_ohp","Schulterdrücken",3,[6,8,10]],["night_laterals","Seitheben",2,[12,12,15]],["night_facepull","Face Pulls",2,[12,12,15]] ]},
  night_lower:{name:"Nachtschicht – Unterkörper (35 Min)",ex:[["night_squat_press","Kniebeugen/Beinpresse",3,[6,8,10]],["night_rdl","Gestrecktes KH",3,[6,8,10]],["night_legext","Beinstrecker",2,[12,12,15]],["night_legcurl","Beinbeuger",2,[12,12,15]],["night_calf","Wadenheben",3,[12,15,20]],["night_core","Bauch",2,[12,12,15]] ]}
};

const ADDONS=[["pullover_cable","Überzüge am Kabelzug",3,[12,12,15]],["revfly_add","Reverse Flys (Zusatz)",2,[12,12,15]],["calf_add","Waden (Zusatz)",3,[12,15,20]]];

function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(STATE)); }
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)) || {logs:[],addons:[]}; }catch(e){ return {logs:[],addons:[]}; } }
function todayISO(){ const d=new Date(); const z=d.getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10); }
function getDate(){ return document.getElementById('datePick').value || todayISO(); }

// Empfehlung
function lastDateFor(sessionKey){
  const firstEx = SESSIONS[sessionKey].ex[0][0];
  const hit = [...STATE.logs].filter(l=>l.exerciseId===firstEx).sort((a,b)=>b.date.localeCompare(a.date))[0];
  return hit? hit.date : null;
}
function hoursSince(s){ if(!s) return 1e12; return (Date.now()-new Date(s+"T00:00:00").getTime())/36e5; }
function recNext(){
  const night = document.getElementById('isNight').checked;
  if(night){
    const last = [...STATE.logs].filter(l=>l.sessionId?.startsWith("night_")).sort((a,b)=>b.date.localeCompare(a.date))[0];
    return (!last || last.sessionId==="night_lower") ? "night_upper":"night_lower";
  }
  const pullH = hoursSince(lastDateFor("free_pull"));
  const pushH = hoursSince(lastDateFor("free_push"));
  const legH  = hoursSince(lastDateFor("free_legs"));
  if(pullH>72) return "free_pull";
  if(pushH>96) return "free_push";
  if(legH>96) return "free_legs";
  const order=["free_push","free_pull","free_legs","free_weak"];
  const last = [...STATE.logs].filter(l=>l.sessionId?.startsWith("free_")).sort((a,b)=>b.date.localeCompare(a.date))[0];
  if(!last) return "free_push";
  const idx = order.indexOf(last.sessionId);
  return order[(idx+1)%order.length];
}
document.getElementById('btnRecommend').onclick = ()=>{
  const k=recNext(); document.getElementById('rec').textContent = "Empfohlen: "+SESSIONS[k].name; document.getElementById('session').value=k;
};

// UI init
const sessionSel=document.getElementById('session');
Object.entries(SESSIONS).forEach(([k,v])=>{const o=document.createElement('option');o.value=k;o.textContent=v.name;sessionSel.appendChild(o);});
const addonSel=document.getElementById('addonSel');
ADDONS.forEach(([id,label])=>{const o=document.createElement('option');o.value=id;o.textContent=label;addonSel.appendChild(o);});

document.getElementById('load').onclick=()=>renderPlan(sessionSel.value);
document.getElementById('addAddon').onclick=()=>{
  const d=getDate(); const todays=STATE.addons.filter(a=>a.date===d);
  if(todays.length>=2){ alert("Max. 2 Add-Ons."); return; }
  STATE.addons.push({date:d,id:addonSel.value}); saveState(); renderPlan(sessionSel.value);
};
document.getElementById('clearToday').onclick=()=>{
  const d=getDate(); STATE.logs=STATE.logs.filter(l=>l.date!==d); STATE.addons=STATE.addons.filter(a=>a.date!==d); saveState(); renderPlan(sessionSel.value);
};

document.getElementById('btnCSV').onclick=()=>{
  let csv="date,session,exercise,weight,reps,note
";
  STATE.logs.forEach(l=>{ csv += `${l.date},${l.sessionId||""},${labelOf(l.exerciseId)},${l.weight||0},"${(l.reps||[]).join('-')}",${(l.note||'').replace(/,/g,';')}
`; });
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='training_logs.csv'; a.click();
};
document.getElementById('btnBackup').onclick=()=>{
  const t=prompt("Backup-JSON hier einfügen (ganzer Text)"); if(!t) return;
  try{ const o=JSON.parse(t); if(Array.isArray(o.logs)) STATE.logs=o.logs; if(Array.isArray(o.addons)) STATE.addons=o.addons; saveState(); alert("Backup importiert."); renderPlan(sessionSel.value); }catch(e){ alert("Ungültiges JSON."); }
};
document.getElementById('btnInstall').onclick=()=> alert("iPhone: Teilen ▸ Zum Home-Bildschirm ▸ Hinzufügen (offline-fähig).");

function labelOf(id){
  for(const s of Object.values(SESSIONS)){ const f=s.ex.find(e=>e[0]===id); if(f) return f[1]; }
  const a=ADDONS.find(x=>x[0]===id); return a? a[1]:id;
}

function lastLogFor(id){
  const x=[...STATE.logs].filter(l=>l.exerciseId===id).sort((a,b)=>b.date.localeCompare(a.date));
  return x[0]||null;
}

function renderPlan(key){
  const box=document.getElementById('list'); box.innerHTML="";
  const d=getDate();
  const base=SESSIONS[key].ex.slice();
  STATE.addons.filter(a=>a.date===d).forEach(a=>{
    const add=ADDONS.find(x=>x[0]===a.id);
    if(add) base.push([add[0], add[1]+" (Add-On)", add[2], add[3]]);
  });
  base.forEach(([id,label,sets,targets])=>{
    const wrap=document.createElement('div'); wrap.className='exercise';
    wrap.innerHTML = `<div><b>${label}</b> <span class="badge">Ziel: ${targets.slice(0,sets).join('/')}</span></div>`;
    const grid=document.createElement('div'); grid.className='grid'; grid.dataset.id=id; grid.dataset.sets=sets;
    // Satzfelder
    for(let i=0;i<sets;i++){ const inp=document.createElement('input'); inp.type='number'; inp.placeholder='Wdh'; inp.inputMode='numeric'; grid.appendChild(inp); }
    // Gewicht
    const kg=document.createElement('input'); kg.type='number'; kg.step='0.5'; kg.placeholder='Gewicht (kg)'; grid.appendChild(kg);
    // +Satz
    const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='+ Satz'; addBtn.onclick=()=>{
      const n=document.createElement('input'); n.type='number'; n.placeholder='Wdh'; n.inputMode='numeric'; grid.insertBefore(n, kg);
    };
    // Notizfeld pro Übung
    const note=document.createElement('input'); note.type='text'; note.className='noteinput'; note.placeholder='Notiz (optional) – z. B. Griff enger, 2–3 RIR, linke Schulter zwickt';
    const last = lastLogFor(id); if(last && last.note){ note.value = last.note; }
    // Speichern
    const saveBtn=document.createElement('button'); saveBtn.className='btn acc'; saveBtn.textContent='Satz speichern';
    saveBtn.onclick=()=>{
      const inputs=[...grid.querySelectorAll('input')];
      const reps=inputs.slice(0,-1).map(i=>parseInt(i.value||"0",10)).filter(v=>v>0);
      const weight=parseFloat(inputs[inputs.length-1].value||"0");
      if(reps.length===0 || !weight){ alert("Bitte Wiederholungen und Gewicht eintragen."); return; }
      STATE.logs.push({date:d,sessionId:key,exerciseId:id,reps,weight,note:note.value||""});
      saveState(); document.getElementById('status').textContent="Gespeichert ✔︎";
    };
    grid.appendChild(addBtn);
    grid.appendChild(saveBtn);
    wrap.appendChild(grid);
    wrap.appendChild(note);
    box.appendChild(wrap);
  });
  document.getElementById('addons').textContent = STATE.addons.filter(a=>a.date===d).map(a=>labelOf(a.id)).join(' · ') || "—";
}

// Start
document.getElementById('datePick').value = todayISO();
renderPlan('free_pull'); document.getElementById('session').value='free_pull';

if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>
