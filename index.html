<!doctype html>
<html lang="de"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TrainingCoach – V13.10 AI‑Pro</title>
<link rel="manifest" href="manifest.json"><link rel="icon" href="icon.png">
<meta name="theme-color" content="#0a0f1c">
<style>
body{margin:0;background:#0a0f1c;color:#e9eefc;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:980px;margin:22px auto;padding:0 14px}
.row{background:#0d162a;border:1px solid #1b2c4f;border-radius:14px;padding:14px;margin:12px 0}
h1{display:flex;gap:10px;align-items:center;font-size:22px;margin:0 0 10px}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #243a69;color:#cfe6ff}
.btn{background:#122242;border:1px solid #274b87;color:#e2e8f0;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn.small{padding:6px 10px;font-size:14px}
.tag{padding:2px 8px;border:1px solid #243a69;border-radius:999px;font-size:12px;color:#bde0ff}
label{font-size:13px;color:#b6c7e6;display:block;margin:6px 0 4px}
input,textarea,select{width:100%;background:#0a1120;border:1px solid #223b6a;color:#e5e7eb;border-radius:10px;padding:9px 11px}
textarea{min-height:76px;resize:vertical}
.hint{color:#9bb0d1;font-size:13px}
.card{background:#0b1222;border:1px solid #1b2c4f;border-radius:14px;padding:12px;margin-top:10px}
</style></head><body>
<div class="wrap">
  <h1>TrainingCoach <span class="pill">V13.10 · AI‑Pro · Auto‑Coach + Smart/Voll‑Backup</span></h1>

  <div class="row">
    <button class="btn" id="btnBackupInsert">Backup einfügen (Text/Datei)</button>
    <button class="btn" id="btnCsv">CSV Export</button>
    <button class="btn small" id="btnQuickBackup">Schnell‑Backup (Text)</button>
    <button class="btn small" id="btnFullBackupFile">Voll‑Backup sichern (Datei)</button>
    <button class="btn small" id="btnFullRestore">Voll‑Backup wiederherstellen</button>
    <input type="file" id="fullBackupFile" accept=".json,application/json" style="display:none">
    <span class="tag">Offline</span>
    <p class="hint">Datei‑Restore nur im Safari‑Browser (Apple‑Limit). Im Kachel‑Modus nutze „Backup einfügen (Text)“.</p>
  </div>

  <div class="row">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label>Nächste empfohlene Einheit</label>
        <div>
          <span id="recommendation" class="tag">—</span>
          <button class="btn small" id="btnRecommend">Empfehlung anzeigen</button>
          <button class="btn small" id="btnApply">Übernehmen</button>
        </div>
        <div class="hint">Regeln: Pull ≤72h · Push/Beine ≤96h · Nachtschicht: Ober/Unter abwechseln.</div>
      </div>
      <div>
        <label><input type="checkbox" id="nightShift"> Nachtschicht heute?</label>
        <label>Datum</label><input type="date" id="datePick">
      </div>
    </div>
    <div class="hint" id="muscles"></div>
  </div>

  <div class="row">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div><strong>Heutige Einheit</strong> <span id="todayTitle" class="tag">—</span></div>
      <div><button class="btn small" id="btnLoadPlan">Plan laden</button> <button class="btn small" id="btnExtraSet">+ Extrasatz</button></div>
    </div>
    <div id="exerciseBox"></div>
  </div>

  <div class="row">
    <div>
      <select id="addonSelect"></select>
      <button class="btn small" id="btnAddOn">+ Add‑On hinzufügen</button>
    </div>
    <p class="hint">Max. 2 Add‑Ons (z. B. Überzüge am Kabelzug, Face Pulls).</p>
  </div>
</div>

<dialog id="dlgBackup"><form method="dialog" style="padding:14px">
  <h3>Backup einfügen</h3>
  <p class="hint">Text einfügen oder JSON‑Datei wählen. Beide Formate werden erkannt.</p>
  <textarea id="backupText" placeholder='{"logs":[...],"lastSessions":{...}}'></textarea>
  <div style="display:flex;gap:10px;align-items:center;margin:10px 0">
    <input type="file" id="backupFile" accept=".json,application/json"/>
    <button class="btn small" id="btnPaste">Aus Zwischenablage einfügen</button>
  </div>
  <div style="display:flex;gap:10px;justify-content:flex-end">
    <button class="btn" value="cancel">Abbrechen</button>
    <button class="btn" id="btnImport">Importieren</button>
  </div>
</form></dialog>

<script>
const LS={DATA:'tc_data_v13',AUTOSAVE:'tc_autosave_v1310',SESS:'tc_lastSessions_v13',TODAY:'tc_today_v13',LAST_EXPORT:'tc_export_ping'};
const $=q=>document.querySelector(q); const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
function getLS(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(_){return d}}; function setLS(k,v){localStorage.setItem(k,JSON.stringify(v))}
const fmtDate=(d=new Date())=>{const z=d.getTimezoneOffset()*60000;return new Date(Date.now()-z).toISOString().slice(0,10)};
const roundTo=(v,q)=>Math.round(v/q)*q; const avg=a=>a.length?a.reduce((x,y)=>x+y,0)/a.length:0;

const PLANS={night_upper:[
  {id:'incl_db',name:'Schrägbankdrücken KH',sets:3,reps:[6,10],type:'press'},
  {id:'pullup',name:'Klimmzüge/Latzug',sets:3,reps:[6,10],type:'row'},
  {id:'row_low',name:'Rudern Low Row',sets:3,reps:[6,10],type:'row'},
  {id:'ohp',name:'Schulterdrücken',sets:3,reps:[6,10],type:'press'},
  {id:'laterals',name:'Seitheben',sets:2,reps:[12,15],type:'iso'},
  {id:'facepull',name:'Face Pulls',sets:2,reps:[12,15],type:'iso'}
],night_lower:[
  {id:'squat_press',name:'Kniebeugen/Beinpresse',sets:3,reps:[6,10],type:'lower'},
  {id:'rdl',name:'Gestrecktes KH',sets:3,reps:[6,10],type:'lower'},
  {id:'legext',name:'Beinstrecker',sets:2,reps:[12,15],type:'iso'},
  {id:'legcurl',name:'Beinbeuger',sets:2,reps:[12,15],type:'iso'},
  {id:'calf',name:'Wadenheben',sets:3,reps:[12,20],type:'iso'},
  {id:'abs',name:'Bauch',sets:2,reps:[12,15],type:'iso'}
],free_push:[
  {id:'bb_flat',name:'Flachbankdrücken LH',sets:4,reps:[6,10],type:'press'},
  {id:'db_incline',name:'Schrägbankdrücken KH',sets:4,reps:[6,10],type:'press'},
  {id:'dips',name:'Dips',sets:3,reps:[8,12],type:'press'},
  {id:'ohp_m',name:'Schulterdrücken',sets:3,reps:[8,12],type:'press'},
  {id:'laterals_v',name:'Seitheben',sets:3,reps:[12,15],type:'iso'},
  {id:'revfly',name:'Reverse Flys',sets:3,reps:[12,15],type:'iso'},
  {id:'tri_push',name:'Trizepsdrücken',sets:3,reps:[8,12],type:'iso'}
],free_pull:[
  {id:'pullup_w',name:'Klimmzüge breit',sets:4,reps:[6,10],type:'row'},
  {id:'row_tbar',name:'Rudern LH/T-Bar',sets:4,reps:[6,10],type:'row'},
  {id:'lat_narrow',name:'Latzug eng',sets:3,reps:[8,12],type:'row'},
  {id:'rdl2',name:'Gestrecktes KH',sets:4,reps:[6,10],type:'lower'},
  {id:'shrugs',name:'Shrugs',sets:3,reps:[10,12],type:'iso'},
  {id:'bi_curls',name:'Bizepscurls',sets:3,reps:[8,12],type:'iso'},
  {id:'hammer',name:'Hammercurls',sets:3,reps:[8,12],type:'iso'}
],free_legs:[
  {id:'squat_press2',name:'Kniebeugen/Beinpresse',sets:4,reps:[6,10],type:'lower'},
  {id:'front',name:'Frontkniebeugen',sets:3,reps:[8,12],type:'lower'},
  {id:'legext2',name:'Beinstrecker',sets:3,reps:[12,15],type:'iso'},
  {id:'legcurl2',name:'Beinbeuger',sets:3,reps:[12,15],type:'iso'},
  {id:'calf_stand',name:'Waden stehend',sets:4,reps:[12,20],type:'iso'},
  {id:'calf_sit',name:'Waden sitzend',sets:4,reps:[12,20],type:'iso'},
  {id:'abs2',name:'Bauch',sets:3,reps:[12,15],type:'iso'}
]};
const ADDONS=[
  {id:'cable_pullover',name:'Überzüge am Kabelzug',sets:3,reps:[12,15],type:'iso'},
  {id:'rear_delt_cable',name:'Reverse Flys (Kabel)',sets:2,reps:[12,15],type:'iso'},
  {id:'facepull_add',name:'Face Pulls',sets:2,reps:[12,15],type:'iso'},
  {id:'rope_crunch',name:'Cable Crunch',sets:3,reps:[12,15],type:'iso'}
];

let data=getLS(LS.DATA,{logs:[],version:'13.10'});
let lastS=getLS(LS.SESS,{});
let today=getLS(LS.TODAY,{date:fmtDate(),sessionId:null,exercises:[],addons:[]});

function hoursSince(dateStr){ if(!dateStr) return 1e9; return (Date.now()-new Date(dateStr+'T00:00:00Z'))/36e5; }
function recNext(dateISO,night){
  if(night){ const a=lastS['night_upper']||'1970-01-01'; const b=lastS['night_lower']||'1970-01-01'; return (new Date(a)>new Date(b))?'night_lower':'night_upper'; }
  if(hoursSince(lastS['free_pull'])>72) return 'free_pull';
  if(hoursSince(lastS['free_push'])>96) return 'free_push';
  if(hoursSince(lastS['free_legs'])>96) return 'free_legs';
  const order=['free_push','free_pull','free_legs'];
  const latest=order.reduce((best,k)=> (new Date(lastS[k]||'1970-01-01')>new Date(best.v||'1970-01-01')?{k,v:lastS[k]}:best),{k:'free_push',v:'1970-01-01'}).k;
  return order[(order.indexOf(latest)+1)%order.length];
}
function coverageText(){
  const cutoff=new Date(Date.now()-7*24*3600*1000).toISOString().slice(0,10);
  const map={push:0,pull:0,legs:0};
  (data.logs||[]).forEach(l=>{ if(l.date<cutoff) return; const s=l.sessionId||'';
    if(s.startsWith('free_push')) map.push++; else if(s.startsWith('free_pull')) map.pull++;
    else if(s.startsWith('free_legs')) map.legs++; else if(s.startsWith('night_upper')){map.push++;map.pull++;}
    else if(s.startsWith('night_lower')){map.legs++;} });
  return `Abdeckung 7T: Push ${map.push}/2, Pull ${map.pull}/2, Beine ${map.legs}/2`;
}

// AI‑Pro Rules per type
const RULES={
  iso:{pctUpHi:0.025,pctUpMed:0.0125,pctDn:0.025,min:0.5,max:1.0,q:0.5},
  press:{pctUpHi:0.03,pctUpMed:0.02,pctDn:0.03,min:1.0,max:2.5,q:0.5},
  row:{pctUpHi:0.03,pctUpMed:0.02,pctDn:0.03,min:1.0,max:2.5,q:0.5},
  lower:{pctUpHi:0.05,pctUpMed:0.03,pctDn:0.04,min:2.5,max:5.0,q:0.5}
};
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function decideNext(ex){
  const r = RULES[ex.type]||RULES.press;
  const low=ex.reps[0], high=ex.reps[1];
  const hist=(data.logs||[]).filter(l=>l.exerciseId===ex.id).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,2);
  if(hist.length===0 || hist[0].weight==null){ return {action:'new',next:null,msg:`neu einarbeiten (${ex.sets}×${low}–${high})`}; }
  const cur=hist[0], prev=hist[1]; const reps=cur.reps||[];
  const meanCur=avg(reps); const meanPrev=prev?avg(prev.reps||[]):null; const trend=(meanPrev!=null)?(meanCur-meanPrev):0;
  const worst=Math.min(...reps); const upperThird=high - Math.ceil((high-low)/3);
  const upperCount=reps.filter(x=>x>=upperThird).length; const belowCount=reps.filter(x=>x<low).length;
  const step=(pct)=>clamp(pct*cur.weight, r.min, r.max);
  const apply=(sign,kg)=>roundTo(Math.max(0, cur.weight + sign*kg), r.q);

  if(worst>=high){ const s=step(r.pctUpHi); return {action:'up',next:apply(+1,s),msg:`alle Sätze ≥${high} → +${s.toFixed(1)}kg`}; }
  if(upperCount>=Math.ceil(ex.sets/2)){ const s=step(r.pctUpMed); return {action:'up',next:apply(+1,s),msg:`oberer Bereich → +${s.toFixed(1)}kg`}; }
  if(belowCount>=Math.ceil(ex.sets/2) || trend<=-1){ const s=step(r.pctDn); return {action:'down',next:apply(-1,s),msg:`unter Soll/Trend − → −${s.toFixed(1)}kg`}; }
  return {action:'hold',next:cur.weight,msg:`halten (${ex.sets}×${low}–${high})`};
}

function exCard(ex){
  const dec=decideNext(ex);
  const last=(data.logs||[]).filter(l=>l.exerciseId===ex.id).sort((a,b)=>b.date.localeCompare(a.date))[0];
  let repsHTML=''; for(let i=0;i<ex.sets;i++){ repsHTML+=`<input type="number" class="rep" inputmode="numeric" placeholder="Wdh" style="text-align:center">`; }
  const prefill = dec.next!=null ? dec.next : (last&&last.weight? last.weight : '');
  const icon = dec.action==='up'?'⬆️':dec.action==='down'?'⬇️':'⏸️';
  return `<div class="card ex" data-id="${ex.id}" data-type="${ex.type}" data-sets="${ex.sets}" data-low="${ex.reps[0]}" data-high="${ex.reps[1]}">
    <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <strong>${ex.name}</strong><span class="hint">${icon} ${dec.next??'—'} kg · ${dec.msg}</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">${repsHTML}</div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
      <input type="number" class="weight" step="0.5" placeholder="Gewicht (kg)" value="${prefill}" style="width:140px">
      <textarea class="note" placeholder="Notiz – Griff/Tempo/RPE (optional)"></textarea>
    </div>
  </div>`;
}

function paintToday(){
  const names={night_upper:'Nachtschicht – Oberkörper',night_lower:'Nachtschicht – Unterkörper',free_push:'Freie Tage – Push',free_pull:'Freie Tage – Pull',free_legs:'Freie Tage – Beine'};
  document.getElementById('todayTitle').textContent = (today.sessionId?names[today.sessionId]:'—') + (today.sessionId?(' · '+today.date):'');
  if(!today.sessionId){ document.getElementById('exerciseBox').innerHTML='<div class="hint">Keine Einheit geladen.</div>'; return; }
  let html=''; today.exercises.forEach(ex=>html+=exCard(ex)); (today.addons||[]).forEach(ex=>html+=exCard(ex));
  document.getElementById('exerciseBox').innerHTML=html;
  $$('.ex').forEach(el=> el.addEventListener('input', ()=>autosaveSet(el)));
}

function loadPlan(sessionId){
  const base=(PLANS[sessionId]||[]).map(x=>({...x}));
  today={date:(document.getElementById('datePick').value||fmtDate()),sessionId,exercises:base,addons:(today.addons||[])};
  setLS(LS.TODAY,today); lastS[sessionId]=today.date; setLS(LS.SESS,lastS);
  paintToday(); document.getElementById('muscles').textContent=coverageText();
}

function autosaveSet(el){
  const id=el.getAttribute('data-id'); const sets=parseInt(el.getAttribute('data-sets'),10);
  const reps=$$('.rep',el).map(r=>parseInt(r.value||'0',10)).filter(v=>v>0).slice(0,sets);
  const weight=parseFloat($('.weight',el).value||'0'); const note=$('.note',el).value||'';
  if(!(reps.length>0 && weight>0)) return;
  data.logs=(data.logs||[]).filter(l=>!(l.date===today.date && l.sessionId===today.sessionId && l.exerciseId===id));
  data.logs.push({date:today.date,sessionId:today.sessionId,exerciseId:id,reps,weight,note});
  setLS(LS.DATA,data);
}

function addAddon(){
  if(!today.sessionId){ alert('Bitte zuerst Plan laden'); return; }
  if((today.addons||[]).length>=2){ alert('Max. 2 Add‑Ons.'); return; }
  const id=document.getElementById('addonSelect').value; const meta=ADDONS.find(a=>a.id===id); if(!meta) return;
  today.addons=(today.addons||[]).concat([{...meta}]); setLS(LS.TODAY,today); paintToday();
}
function extraSet(){ if(!today.sessionId){alert('Bitte zuerst Plan laden');return;} [...today.exercises,...(today.addons||[])].forEach(ex=>ex.sets=Math.min(ex.sets+1,6)); setLS(LS.TODAY,today); paintToday(); }

function suggest(){
  const s=recNext(document.getElementById('datePick').value||fmtDate(), document.getElementById('nightShift').checked);
  const names={night_upper:'Nachtschicht – Oberkörper',night_lower:'Nachtschicht – Unterkörper',free_push:'Freie Tage – Push',free_pull:'Freie Tage – Pull',free_legs:'Freie Tage – Beine'};
  document.getElementById('recommendation').textContent = names[s];
  document.getElementById('btnApply').onclick=()=>loadPlan(s);
}

function coverageText(){ return coverageText_; }
function coverageText_(){
  const cutoff=new Date(Date.now()-7*24*3600*1000).toISOString().slice(0,10);
  const map={push:0,pull:0,legs:0};
  (data.logs||[]).forEach(l=>{ if(l.date<cutoff) return; const s=l.sessionId||'';
    if(s.startsWith('free_push')) map.push++; else if(s.startsWith('free_pull')) map.pull++;
    else if(s.startsWith('free_legs')) map.legs++; else if(s.startsWith('night_upper')){map.push++;map.pull++;}
    else if(s.startsWith('night_lower')){map.legs++;} });
  return `Abdeckung 7T: Push ${map.push}/2, Pull ${map.pull}/2, Beine ${map.legs}/2`;
}

// Backup
document.getElementById('btnCsv').onclick=()=>{
  let rows=[['date','sessionId','exerciseId','weight','reps','note']];
  (data.logs||[]).forEach(l=>rows.push([l.date,l.sessionId,l.exerciseId,l.weight,(l.reps||[]).join('/'),(l.note||'').replace(/,/g,';')]));
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='training_logs.csv'; a.click();
};

document.getElementById('btnQuickBackup').onclick=()=>{
  const payload=JSON.stringify({version:'13.10',created:new Date().toISOString(),logs:data.logs,lastSessions:lastS,today},null,2);
  navigator.clipboard.writeText(payload).catch(()=>{
    const b=new Blob([payload],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='training_backup_'+fmtDate()+'.json'; a.click();
  });
};

function makeFullBackupBlob(){ const dump={}; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); dump[k]=localStorage.getItem(k);} const payload={type:'TrainingCoach-FULLBACKUP',created:new Date().toISOString(),localStorageDump:dump}; return new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); }
document.getElementById('btnFullBackupFile').onclick=()=>{ const blob=makeFullBackupBlob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='trainingcoach_fullbackup_'+fmtDate()+'.json'; a.click(); };
document.getElementById('btnFullRestore').onclick=()=>document.getElementById('fullBackupFile').click();
document.getElementById('fullBackupFile').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const obj=JSON.parse(fr.result);
  if(obj?.type!=='TrainingCoach-FULLBACKUP'||!obj.localStorageDump){alert('Ungültiges Voll‑Backup.');return;}
  if(!confirm('Das überschreibt deinen aktuellen Stand. Fortfahren?')) return; localStorage.clear(); Object.entries(obj.localStorageDump).forEach(([k,v])=>localStorage.setItem(k,v)); location.reload();
} catch(_){alert('Backup konnte nicht gelesen werden.');} }; fr.readAsText(f); });

// Smart Import
document.getElementById('btnBackupInsert').onclick=()=>document.getElementById('dlgBackup').showModal();
document.getElementById('btnPaste').onclick=async (e)=>{ e.preventDefault(); try{ const t=await navigator.clipboard.readText(); document.getElementById('backupText').value=t; }catch{} };
document.getElementById('btnImport').onclick=(e)=>{ e.preventDefault(); const file=document.getElementById('backupFile').files[0]; if(file){ const fr=new FileReader(); fr.onload=()=>doImport(fr.result); fr.readAsText(file);} else { doImport((document.getElementById('backupText').value||'').trim()); } };
function doImport(txt){ let obj=null; try{ obj=JSON.parse(txt);}catch(_){ alert('Kein gültiges JSON.'); return;}
  if(obj && obj.localStorageDump){ if(!confirm('Voll‑Backup erkannt. Aktuellen Stand überschreiben?')) return; localStorage.clear(); Object.entries(obj.localStorageDump).forEach(([k,v])=>localStorage.setItem(k,v)); location.reload(); return; }
  if(obj.logs){ data.logs=(data.logs||[]).concat(obj.logs); } if(obj.lastSessions){ lastS={...lastS,...obj.lastSessions}; setLS(LS.SESS,lastS); } if(obj.today){ today=obj.today; setLS(LS.TODAY,today); }
  setLS(LS.DATA,data); document.getElementById('dlgBackup').close(); document.getElementById('muscles').textContent=coverageText(); paintToday();
}

// Init
document.getElementById('datePick').value = today.date || fmtDate();
document.getElementById('addonSelect').innerHTML = [{id:'',name:'— Add‑On wählen —'},...ADDONS].map(a=>`<option value='${a.id}'>${a.name||a.id}</option>`).join('');
document.getElementById('btnRecommend').onclick=()=>suggest();
document.getElementById('btnApply').onclick=()=>{};
document.getElementById('btnLoadPlan').onclick=()=>{ const s=recNext(document.getElementById('datePick').value||fmtDate(), document.getElementById('nightShift').checked); loadPlan(s); };
document.getElementById('btnAddOn').onclick=()=>addAddon();
document.getElementById('btnExtraSet').onclick=()=>extraSet();
function start(){ suggest(); document.getElementById('muscles').textContent=coverageText(); paintToday(); }
start();

if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
</script>
</body></html>
