<!doctype html>
<html lang="de">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trainingscoach – V12 (Add‑Ons & variable Sätze)</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Trainingscoach">
<link rel="apple-touch-icon" href="icon.png">
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;color:#0f172a}
header{background:#0f172a;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
h1{margin:0;font-size:18px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.card{background:#fff;margin:12px;padding:12px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
label{font-size:13px;color:#64748b;display:block;margin-top:6px}
select,input,textarea{width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;margin-top:4px}
.ex{border:1px solid #e2e8f0;border-radius:10px;padding:10px;margin-top:10px}
.ex h3{margin:0;font-size:15px}
.sets{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
button{background:#0ea5e9;color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:14px;cursor:pointer}
button.secondary{background:#e2e8f0;color:#0f172a}
button.ghost{background:transparent;color:#0f172a;border:1px dashed #94a3b8}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.hint{font-size:12px;color:#64748b;margin-top:6px}
.badge{background:#e2e8f0;padding:2px 6px;border-radius:6px;font-size:11px;margin-left:6px}
.coach-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
.coach-title{font-weight:700}
.coach-text{color:#0f172a;opacity:.9;margin-top:4px}
.toggle{display:flex;align-items:center;gap:8px;margin-right:8px}
.suggest{font-size:12px;color:#0f172a;opacity:.8;margin-top:6px}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0ea5e9;color:#fff;padding:8px 12px;border-radius:999px;box-shadow:0 6px 18px rgba(0,0,0,.2);z-index:60}
.toast.hidden{display:none}
textarea.paste{height:120px}
small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;color:#64748b}
.addon-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
</style>
<header>
  <h1>Trainingscoach – V12</h1>
  <div class="actions">
    <button id="pasteJson">Backup-Text einfügen</button>
    <button id="exportCsv">CSV Export</button>
  </div>
</header>

<section class="card" id="coachCard">
  <div class="coach-row">
    <div style="flex:1">
      <div class="coach-title">Empfehlung für heute</div>
      <div id="coachText" class="coach-text">—</div>
    </div>
    <div class="coach-actions">
      <label class="toggle">
        <input type="checkbox" id="nightMode"><span>Nachtschicht heute?</span>
      </label>
      <button id="applyReco" class="secondary">Übernehmen</button>
    </div>
  </div>
  <div class="hint">Regeln: Pull ≤72h · Push/Beine ≤96h · sonst Zyklus (Push→Pull→Beine→Schwachstellen / Ober↔Unter).</div>
</section>

<section class="card">
  <label>Heutige Einheit</label>
  <select id="sessionSelect"></select>
  <div class="hint">Alias-Mapping aktiv · Offline, keine Website nötig</div>
  <label>Datum</label>
  <input type="date" id="dateInput">
</section>

<section id="workout" class="card"></section>

<section class="card">
  <div class="controls">
    <button id="addAddon" class="ghost">＋ Add‑On Übung</button>
    <select id="addonSelect">
      <option value="pullover">Überzüge am Kabelzug</option>
      <option value="revfly">Reverse Flys</option>
      <option value="abs">Bauch</option>
      <option value="calves_stand">Waden stehend</option>
      <option value="ext_rot">Außenrotation Kabel</option>
    </select>
    <span class="hint">Add‑Ons: 2–3×12–15, RIR 1–2. Max. 2 Extras.</span>
  </div>
</section>

<div id="toast" class="toast hidden">Backup aktualisiert</div>

<section class="card" id="pasteCard" style="display:none">
  <b>Backup-Text einfügen (JSON)</b>
  <textarea class="paste" id="pasteArea" placeholder='Füge hier den Inhalt deiner Datei "training_backup_YYYY-MM-DD.json" ein und klicke dann auf "Importieren".'></textarea>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
    <button id="doPasteImport">Importieren</button>
    <button class="secondary" id="cancelPaste">Abbrechen</button>
  </div>
  <div class="hint"><small class="mono">Hinweis:</small> Dateidialog-frei – funktioniert auch bei lokal geöffneter HTML.</div>
</section>

<script>
const MICRO=0.5, STEP=2.5;
const LS_LOGS='logs_local_v1', LS_LAST='last_session_local_v1', LS_NIGHT='night_mode_local_v1', LS_LAST_BACKUP='last_backup_date_local_v1', LS_BACKUP_JSON='last_backup_json_local_v1', LS_SETS_PREF='sets_pref_v1';

const EXS={
  flat_bb:{name:'Flachbankdrücken LH',sets:4,min:6,max:10,step:STEP},
  incline_db:{name:'Schrägbankdrücken KH',sets:4,min:6,max:10,step:STEP},
  dips:{name:'Dips (vorbeugt)',sets:3,min:8,max:12,step:STEP},
  ohp:{name:'Schulterdrücken',sets:4,min:6,max:10,step:STEP},
  laterals:{name:'Seitheben',sets:3,min:12,max:15,step:MICRO},
  revfly:{name:'Reverse Flys',sets:3,min:12,max:15,step:MICRO},
  tri_push:{name:'Trizepsdrücken',sets:3,min:8,max:12,step:MICRO},
  pullups_wide:{name:'Klimmzüge breit',sets:4,min:6,max:10,step:STEP},
  row_tbar:{name:'Rudern LH/T-Bar',sets:4,min:6,max:10,step:STEP},
  lat_close:{name:'Latzug eng',sets:3,min:8,max:12,step:STEP},
  facepull:{name:'Face Pulls',sets:3,min:12,max:15,step:MICRO},
  shrugs:{name:'Shrugs',sets:3,min:10,max:12,step:STEP},
  curls:{name:'Bizepscurls',sets:3,min:8,max:12,step:MICRO},
  hammer:{name:'Hammercurls',sets:3,min:8,max:12,step:MICRO},
  squat_press:{name:'Kniebeugen/Beinpresse',sets:4,min:6,max:10,step:STEP},
  front_squat:{name:'Frontkniebeugen',sets:3,min:8,max:12,step:STEP},
  legext:{name:'Beinstrecker',sets:3,min:12,max:15,step:MICRO},
  rdl:{name:'Gestrecktes KH',sets:4,min:6,max:10,step:STEP},
  legcurl:{name:'Beinbeuger',sets:3,min:12,max:15,step:MICRO},
  calves_stand:{name:'Waden stehend',sets:4,min:12,max:20,step:MICRO},
  calves_seat:{name:'Waden sitzend',sets:3,min:12,max:20,step:MICRO},
  abs:{name:'Bauch',sets:3,min:12,max:15,step:MICRO},
  incline_db_s:{name:'Schrägbankdrücken KH',sets:3,min:6,max:10,step:STEP},
  butterfly:{name:'Butterfly/Kabel',sets:3,min:12,max:15,step:MICRO},
  row_1arm:{name:'Rudern einarmig KH',sets:3,min:8,max:12,step:STEP},
  pullups_neutral:{name:'Klimmzüge neutral',sets:3,min:6,max:10,step:STEP},
  ohp_mach:{name:'Schulterdrücken Maschine',sets:3,min:6,max:10,step:STEP},
  laterals_drop:{name:'Seitheben Dropset',sets:3,min:12,max:15,step:MICRO},
  face_rev:{name:'Face Pulls/Reverse Flys',sets:3,min:12,max:15,step:MICRO},
  arms_ss_bi:{name:'Bizeps (Superset)',sets:3,min:10,max:12,step:MICRO},
  arms_ss_tri:{name:'Trizeps (Superset)',sets:3,min:10,max:12,step:MICRO},
  pullover:{name:'Überzüge am Kabelzug',sets:3,min:10,max:12,step:MICRO},
  night_incline:{name:'Schrägbankdrücken KH',sets:3,min:6,max:10,step:STEP},
  night_pullups:{name:'Klimmzüge/Latzug',sets:3,min:6,max:10,step:STEP},
  night_lowrow:{name:'Rudern Low Row',sets:3,min:6,max:10,step:STEP},
  night_ohp:{name:'Schulterdrücken',sets:3,min:6,max:10,step:STEP},
  night_laterals:{name:'Seitheben',sets:2,min:12,max:15,step:MICRO},
  night_facepull:{name:'Face Pulls',sets:2,min:12,max:15,step:MICRO},
  night_squat:{name:'Kniebeugen/Beinpresse',sets:3,min:6,max:10,step:STEP},
  night_rdl:{name:'Gestrecktes KH',sets:3,min:6,max:10,step:STEP},
  night_legext:{name:'Beinstrecker',sets:2,min:12,max:15,step:MICRO},
  night_legcurl:{name:'Beinbeuger',sets:2,min:12,max:15,step:MICRO},
  night_calves:{name:'Wadenheben',sets:3,min:12,max:20,step:MICRO},
  ext_rot:{name:'Außenrotation Kabel',sets:2,min:12,max:20,step:MICRO}
};

const SESSIONS=[
  {id:'night_upper',label:'Nachtschicht – Oberkörper',group:'pull',ex:[
    ['night_incline'],['night_pullups'],['night_lowrow'],['night_ohp'],['night_laterals'],['night_facepull']
  ]},
  {id:'night_lower',label:'Nachtschicht – Unterkörper',group:'legs',ex:[
    ['night_squat'],['night_rdl'],['night_legext'],['night_legcurl'],['night_calves']
  ]},
  {id:'free_push',label:'Freie Tage – Push',group:'push',ex:[
    ['flat_bb'],['incline_db'],['dips'],['ohp'],['laterals'],['revfly'],['tri_push']
  ]},
  {id:'free_pull',label:'Freie Tage – Pull',group:'pull',ex:[
    ['pullups_wide'],['row_tbar'],['lat_close'],['facepull'],['shrugs'],['curls'],['hammer']
  ]},
  {id:'free_legs',label:'Freie Tage – Beine',group:'legs',ex:[
    ['squat_press'],['front_squat'],['legext'],['rdl'],['legcurl'],['calves_stand'],['calves_seat'],['abs']
  ]},
  {id:'free_weak',label:'Freie Tage – Schwachstellen (+Überzüge)',group:'assist',ex:[
    ['incline_db_s'],['butterfly'],['row_1arm'],['pullups_neutral'],['ohp_mach'],['laterals_drop'],['face_rev'],
    ['arms_ss_bi'],['arms_ss_tri'],['pullover']
  ], superset:['arms_ss_bi','arms_ss_tri']}
];

const ALIAS = {
  night_incline:['incline_db'],
  night_pullups:['pullups_wide','lat_close'],
  night_lowrow:['row_tbar','row_1arm'],
  night_ohp:['ohp','ohp_mach'],
  night_laterals:['laterals','laterals_drop'],
  night_facepull:['facepull','face_rev'],
  night_squat:['squat_press'],
  night_rdl:['rdl'],
  night_legext:['legext'],
  night_legcurl:['legcurl'],
  night_calves:['calves_stand','calves_seat'],
  incline_db:['night_incline'],
  pullups_wide:['night_pullups'], lat_close:['night_pullups'],
  row_tbar:['night_lowrow'], row_1arm:['night_lowrow'],
  ohp:['night_ohp'], ohp_mach:['night_ohp'],
  laterals:['night_laterals'], laterals_drop:['night_laterals'],
  facepull:['night_facepull'], face_rev:['night_facepull'],
  squat_press:['night_squat'], rdl:['night_rdl'],
  legext:['night_legext'], legcurl:['night_legcurl'],
  calves_stand:['night_calves'], calves_seat:['night_calves']
};

let logs=JSON.parse(localStorage.getItem(LS_LOGS)||'[]');
let setsPref = JSON.parse(localStorage.getItem(LS_SETS_PREF)||'{}');

function saveLogs(){ localStorage.setItem(LS_LOGS, JSON.stringify(logs)); }
function saveSetsPref(){ localStorage.setItem(LS_SETS_PREF, JSON.stringify(setsPref)); }
function saveLastSession(sessionId, date){ localStorage.setItem(LS_LAST, JSON.stringify({sessionId, date})); }
function loadLastSession(){ try{ return JSON.parse(localStorage.getItem(LS_LAST)||'null'); }catch{ return null; } }
function saveNightMode(on){ localStorage.setItem(LS_NIGHT, on?'1':'0'); }
function loadNightMode(){ return localStorage.getItem(LS_NIGHT)==='1'; }

function todayISO(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
function hoursBetween(a,b){ try{ return Math.abs((new Date(a)-new Date(b))/36e5); }catch{return null;} }
function hoursSince(dateStr){ try{ return (new Date()-new Date(dateStr))/36e5; }catch{return null;} }

function lastByGroup(){
  const map={push:null,pull:null,legs:null,assist:null};
  for(const l of logs){
    const sess=SESSIONS.find(s=>s.id===l.sessionId);
    if(!sess) continue;
    const g = sess.group||'assist';
    const dt = l.date;
    if(!map[g] || map[g]<dt) map[g]=dt;
  }
  return map;
}
function roundToStep(w, step){
  if(!w || !isFinite(w)) return 0;
  const k = Math.round(w/step)*step;
  return Math.round(k*10)/10;
}
function getLastLogWithAlias(exId){
  const ids = [exId, ...(ALIAS[exId]||[])];
  let best=null;
  for(const id of ids){
    const l = logs.filter(x=>x.exerciseId===id).sort((a,b)=> b.date.localeCompare(a.date))[0];
    if(l && (!best || l.date>best.date)) best=l;
  }
  return best;
}
function suggestWeight(exId, cfg, desiredSets){
  const lastLog = getLastLogWithAlias(exId);
  const sets = desiredSets || setsPref[exId] || (cfg.sets||3);
  if(!lastLog) return {w:0, note:'Neustart – moderat wählen', target: Array(sets).fill(cfg.min)};
  const step = cfg.step || EXS[exId].step || STEP;
  const w = Number(lastLog.weight||0);
  const reps = (lastLog.reps||[]).map(Number);
  const useSets = Math.max(sets, reps.length||sets);
  let target = Array(useSets).fill(cfg.min);
  const allAtTop = reps.length>=useSets && reps.slice(0,useSets).every(r=>r>=cfg.max);
  const anyBelowMin = reps.slice(0,useSets).some(r=>r<cfg.min);
  if(allAtTop){
    const wNext = roundToStep(w + step, step);
    target = Array(useSets).fill(cfg.min);
    return {w:wNext, note:`+${step} kg · starte bei ${cfg.min}`, target};
  }
  if(anyBelowMin){
    const wNext = roundToStep(w*0.95, step);
    target = Array(useSets).fill(cfg.min);
    return {w:wNext, note:`Deload −5%`, target};
  }
  target = Array(useSets).fill(cfg.min).map((_,i)=> Math.min(cfg.max, (reps[i]||cfg.min)+1));
  return {w:w, note:`Gewicht halten`, target};
}

const FREE_ORDER=['free_push','free_pull','free_legs','free_weak'];
const NIGHT_ORDER=['night_upper','night_lower'];
function nextInCycle(current, order){
  const idx=order.indexOf(current);
  return order[(idx+1+order.length)%order.length];
}
function computeRecommendation(nightMode){
  const last = loadLastSession();
  const groups = lastByGroup();
  const today = todayISO();
  const pullH = groups.pull ? hoursBetween(today, groups.pull) : 1e9;
  const pushH = groups.push ? hoursBetween(today, groups.push) : 1e9;
  const legsH = groups.legs ? hoursBetween(today, groups.legs) : 1e9;
  if (pullH > 72) return {sessionId: nightMode ? 'night_upper' : 'free_pull', note:`Pull überfällig (${Math.floor(pullH)}h).`};
  if (pushH > 96) return {sessionId: nightMode ? 'night_upper' : 'free_push', note:`Push überfällig (${Math.floor(pushH)}h).`};
  if (legsH > 96) return {sessionId: nightMode ? 'night_lower' : 'free_legs', note:`Beine überfällig (${Math.floor(legsH)}h).`};
  const order = nightMode ? NIGHT_ORDER : FREE_ORDER;
  const fallback = order[0];
  if (!last) return {sessionId: fallback, note:'Kein Verlauf → starte Zyklus.'};
  const next = nextInCycle(last.sessionId, order);
  const h = hoursSince(last.date);
  let restNote = "";
  if (h!=null && h<36) restNote = " (<36h moderat)";
  return {sessionId: next, note:`Letzte: ${labelFor(last.sessionId)} · Pause ~${h?Math.round(h):'?'}h${restNote}`};
}

const sessionSelect=document.getElementById('sessionSelect');
const dateInput=document.getElementById('dateInput');
const workout=document.getElementById('workout');
const coachText=document.getElementById('coachText');
const applyReco=document.getElementById('applyReco');
const nightModeEl=document.getElementById('nightMode');
const exportBtn=document.getElementById('exportCsv');
const pasteBtn=document.getElementById('pasteJson');
const pasteCard=document.getElementById('pasteCard');
const pasteArea=document.getElementById('pasteArea');
const doPasteImport=document.getElementById('doPasteImport');
const cancelPaste=document.getElementById('cancelPaste');
const toast=document.getElementById('toast');
const addonBtn=document.getElementById('addAddon');
const addonSelect=document.getElementById('addonSelect');

function labelFor(id){ return (SESSIONS.find(s=>s.id===id)||{}).label || id; }

function init(){
  dateInput.value = todayISO();
  SESSIONS.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.label; sessionSelect.appendChild(o); });
  nightModeEl.checked = loadNightMode();

  autoRestoreIfPossible();

  const rec = computeRecommendation(nightModeEl.checked);
  coachText.textContent = `Nächste empfohlene Einheit: ${labelFor(rec.sessionId)} · ${rec.note}`;
  sessionSelect.value = rec.sessionId;
  renderWorkout();
  autoBackupIfNeeded();

  nightModeEl.onchange = ()=>{
    saveNightMode(nightModeEl.checked);
    const r = computeRecommendation(nightModeEl.checked);
    coachText.textContent = `Nächste empfohlene Einheit: ${labelFor(r.sessionId)} · ${r.note}`;
    sessionSelect.value = r.sessionId;
    renderWorkout();
  };
  applyReco.onclick = ()=>{
    const r = computeRecommendation(nightModeEl.checked);
    sessionSelect.value = r.sessionId;
    renderWorkout();
  };
  sessionSelect.onchange = ()=> renderWorkout();
  exportBtn.onclick = exportCSV;

  pasteBtn.onclick = ()=>{ pasteCard.style.display='block'; window.scrollTo(0,document.body.scrollHeight); };
  cancelPaste.onclick = ()=>{ pasteCard.style.display='none'; };
  doPasteImport.onclick = ()=>{
    try{
      const obj = JSON.parse(pasteArea.value);
      if(!obj || !Array.isArray(obj.logs)) throw new Error('Kein gültiges JSON');
      importFromArray(obj.logs);
      localStorage.setItem(LS_BACKUP_JSON, JSON.stringify(obj));
      pasteCard.style.display='none';
      pasteArea.value='';
      showToast('Backup importiert');
    }catch(e){ alert('JSON konnte nicht gelesen werden. Prüfe die Klammern/Anführungszeichen.'); }
  };

  addonBtn.onclick = ()=> addAddon(addonSelect.value);
}

function importFromArray(rows){
  let added=0, skipped=0;
  const dedup = new Set(logs.map(l=>`${l.date}|${l.sessionId}|${l.exerciseId}|${l.weight}|${(l.reps||[]).join('/')}|${l.notes||''}`));
  for(const r of rows){
    const key = `${r.date}|${r.sessionId}|${r.exerciseId}|${r.weight}|${(r.reps||[]).join('/')}|${r.notes||''}`;
    if(dedup.has(key)){ skipped++; continue; }
    logs.unshift({date:r.date, sessionId:r.sessionId, exerciseId:r.exerciseId, weight:r.weight, reps:r.reps, notes:r.notes||''});
    dedup.add(key); added++;
  }
  saveLogs();
  const lastRow = rows.sort((a,b)=> (a.date<b.date?1:-1))[0];
  if(lastRow){ saveLastSession(lastRow.sessionId, lastRow.date); }
  renderWorkout();
  const rec = computeRecommendation(loadNightMode());
  coachText.textContent = `Nächste empfohlene Einheit: ${labelFor(rec.sessionId)} · ${rec.note}`;
}

function autoRestoreIfPossible(){
  if(logs && logs.length) return;
  try{
    const b = localStorage.getItem(LS_BACKUP_JSON);
    if(b){
      const obj = JSON.parse(b);
      if(obj && Array.isArray(obj.logs)){ importFromArray(obj.logs); showToast('Automatisch aus letztem Backup wiederhergestellt'); return; }
    }
  }catch(e){}
}

function addExerciseCard(exId, overrides, isAddon=false){
  const base = EXS[exId];
  const cfg = {...base, ...(overrides||{})};
  const desiredSets = setsPref[exId] || cfg.sets;
  const sugg = suggestWeight(exId, cfg, desiredSets);

  const card=document.createElement('div'); card.className='ex';
  card.dataset.exerciseId = exId;
  let currentSets = desiredSets || (sugg.target?sugg.target.length:cfg.sets);

  card.innerHTML = `
    <h3>${cfg.name} <span class="badge"><span class="setsCount">${currentSets}</span>×${cfg.min}–${cfg.max}</span> ${isAddon?'<span class="badge">Add‑On</span>':''}</h3>
    <div class="suggest">Vorschlag: <b>${sugg.w||0} kg</b> · ${sugg.note} <span class="badge">Ziel-Wdh: <span class="targetText">${sugg.target.join('/')}</span></span></div>
    <div class="controls" style="margin-top:8px">
      <button class="secondary minusSet">– Satz</button>
      <button class="secondary plusSet">+ Satz</button>
    </div>
    <div class="sets"></div>
    <div style="display:grid;grid-template-columns:1fr 2fr;gap:8px;margin-top:8px">
      <input type="number" step="${cfg.step}" placeholder="Gewicht (kg)" class="w" value="${sugg.w||0}">
      <input type="text" placeholder="Notiz (optional)" class="n">
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="save">Satz speichern</button>
      ${isAddon?'<button class="secondary remove">Entfernen</button>':''}
    </div>`;

  const setsDiv = card.querySelector('.sets');
  function renderSetInputs(){
    setsDiv.innerHTML='';
    for(let i=0;i<currentSets;i++){
      const wrap = document.createElement('div');
      wrap.innerHTML = `<label>Satz ${i+1} Wdh</label><input type="number" class="r" placeholder="${cfg.min}-${cfg.max}">`;
      setsDiv.appendChild(wrap);
    }
    card.querySelector('.setsCount').textContent = currentSets;
    const t = (sugg.target||Array(currentSets).fill(cfg.min)).slice(0,currentSets);
    card.querySelector('.targetText').textContent = t.join('/');
  }
  renderSetInputs();

  card.querySelector('.plusSet').onclick=()=>{ currentSets++; renderSetInputs(); };
  card.querySelector('.minusSet').onclick=()=>{ if(currentSets>1){ currentSets--; renderSetInputs(); } };

  card.querySelector('.save').onclick=()=>{
    const w=Number(card.querySelector('.w').value||0);
    const reps=[...card.querySelectorAll('.r')].map(i=>Number(i.value||0));
    if(reps.some(r=>!Number.isFinite(r) || r<=0)){ alert('Bitte alle Wdh-Felder ausfüllen.'); return; }
    const n=card.querySelector('.n').value||"";
    logs=[{date: dateInput.value, sessionId: sessionSelect.value, exerciseId: exId, weight: w, reps, notes: n}, ...logs];
    setsPref[exId]=reps.length;
    saveLogs(); saveSetsPref();
    const lastSaved = JSON.parse(localStorage.getItem(LS_LAST)||'null');
    if (!lastSaved || lastSaved.date!==dateInput.value){
      localStorage.setItem(LS_LAST, JSON.stringify({sessionId: sessionSelect.value, date: dateInput.value}));
    }
    renderWorkout();
    const rec = computeRecommendation(nightModeEl.checked);
    coachText.textContent = `Nächste empfohlene Einheit: ${labelFor(rec.sessionId)} · ${rec.note}`;
    autoBackupIfNeeded(true);
    try{ localStorage.setItem(LS_BACKUP_JSON, JSON.stringify({logs})); }catch(e){}
    showToast('Backup aktualisiert');
  };

  if(isAddon){
    card.querySelector('.remove').onclick=()=>{ card.remove(); };
  }

  workout.appendChild(card);
}

function renderWorkout(){
  workout.innerHTML = "";
  const sess = SESSIONS.find(s=>s.id===sessionSelect.value);
  if (!sess) return;
  if (sess.superset){
    const info=document.createElement('div'); info.className='hint';
    info.innerHTML="<b>Superset:</b> Bizeps → Trizeps (3 Runden), Pause 60–90 s nach Trizeps.";
    workout.appendChild(info);
  }
  sess.ex.forEach(([exId,ov])=> addExerciseCard(exId, ov));
}

function addAddon(exId){
  const existingAddons = [...document.querySelectorAll('#workout .ex')].filter(x=> x.querySelector('.badge') && x.querySelector('.badge').textContent.includes('Add‑On')).length;
  if(existingAddons>=2){ alert('Max. 2 Add‑Ons pro Einheit.'); return; }
  addExerciseCard(exId, {sets:2,min:12,max:15,step:EXS[exId]?.step||MICRO}, true);
  showToast('Add‑On hinzugefügt');
}

function exportCSV(){
  const header=["date","session","exercise","weight","reps","notes"].join(",");
  const rows=logs.map(l=>[l.date,l.sessionId,l.exerciseId,l.weight,(l.reps||[]).join("/"),`"${(l.notes||"").replace(/"/g,'""')}"`].join(","));
  const blob=new Blob([header+"\n"+rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="training_logs.csv"; a.click(); URL.revokeObjectURL(url);
}

function autoBackupIfNeeded(force=false){
  try{
    const today = todayISO();
    const last = localStorage.getItem(LS_LAST_BACKUP);
    if(force || last !== today){
      const data = JSON.stringify({logs, meta:{ts:new Date().toISOString(), version:'pwa_v12'}}, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `training_backup_${today}.json`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
      localStorage.setItem(LS_LAST_BACKUP, today);
      localStorage.setItem(LS_BACKUP_JSON, JSON.stringify({logs}));
    }
  }catch(e){}
}

function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg||'OK'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1500); }

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js'); });
}

function labelFor(id){ return (SESSIONS.find(s=>s.id===id)||{}).label || id; }

const sessionSelect=document.getElementById('sessionSelect');
const dateInput=document.getElementById('dateInput');

init();
</script>
</html>
