<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trainingscoach – V13.4</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<style>
:root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --card:#0b1220 }
* { box-sizing:border-box } body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text) }
header { position:sticky; top:0; z-index:5; background:#0b1220; border-bottom:1px solid #1f2937; padding:14px 16px; display:flex; gap:12px; align-items:center }
h1 { font-size:20px; margin:0; font-weight:700 } .badge { font-size:12px; background:#1f2937; color:#93c5fd; padding:4px 8px; border-radius:999px; margin-left:8px }
main { padding:16px; display:flex; flex-direction:column; gap:14px }
.panel { background:var(--panel); border:1px solid #1f2937; border-radius:14px; padding:14px }
.row { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
button { background:#1e293b; color:#e2e8f0; border:1px solid #334155; padding:10px 14px; border-radius:10px; font-weight:600 }
button.primary { background:#0284c7; border-color:#0284c7 } button:disabled { opacity:.5 }
input, select, textarea { background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px }
.muted { color:var(--muted); font-size:12px } .exercise { background:#0b1220; border:1px solid #1f2937; border-radius:14px; padding:12px; margin-top:8px }
.exercise h3 { margin:0 0 6px 0; font-size:16px } .grid { display:grid; grid-template-columns: repeat(4, minmax(72px,1fr)); gap:8px } .note{ width:100% }
.tag { font-size:11px; background:#0b1220; border:1px solid #334155; padding:2px 8px; border-radius:999px; color:#93c5fd }
footer { text-align:center; color:#94a3b8; padding:24px 0 } .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #334155; background:#0b1220 }
</style>
</head>
<body>
<header><h1>Trainingscoach <span class="badge">V13.4</span></h1></header>
<main>
  <div class="panel">
    <div class="row" style="gap:10px; flex-wrap:wrap">
      <button id="btnPaste">Backup‑Text einfügen</button>
      <button id="btnExport">CSV Export</button>
      <button id="btnInstall">Zum Home‑Bildschirm (Hinweis)</button>
    </div>
    <div class="muted" style="margin-top:8px">Offline‑fähig · Daten bleiben lokal</div>
  </div>

  <div class="panel">
    <div class="muted">Empfehlung: Pull ≤72 h, Push/Beine ≤96 h; sonst Zyklus. Nachtschicht: Ober/Unter im Wechsel.</div>
    <div class="row" style="margin-top:12px">
      <label class="row" style="align-items:center; gap:8px">
        <input type="checkbox" id="nightShift" /> Nachtschicht heute?
      </label>
      <input type="date" id="datePick" />
      <button id="btnSuggest">Empfehlung anzeigen</button>
    </div>
    <div id="suggestBox" class="row" style="margin-top:10px; gap:8px"></div>
  </div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0; font-size:18px">Heutige Einheit</h2>
      <button class="primary" id="btnLoadPlan">Plan laden</button>
    </div>
    <div id="todayBox"></div>
  </div>

  <div class="panel">
    <h2 style="margin:0; font-size:18px">Add‑On Übung (max. 2 pro Tag)</h2>
    <div class="row" style="margin-top:10px">
      <select id="addonSelect"></select>
      <button id="btnAddOn">+ hinzufügen</button>
    </div>
    <div id="addonsBox"></div>
    <div class="muted" style="margin-top:8px">Add‑Ons: 2–3×12–15, RIR 1–2.</div>
  </div>

  <div class="panel">
    <button id="btnClear">Heutige Einheit leeren</button>
  </div>
</main>
<footer>© Coach – V13.4</footer>

<script>
const $ = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
const store = { get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };
const fmtDate = (d=new Date()) => d.toISOString().slice(0,10);

const PLANS = {
  night_upper:[{id:"incl_db",name:"Schrägbankdrücken KH",sets:3,reps:"6–10"},{id:"pullup",name:"Klimmzüge/Latzug",sets:3,reps:"6–10"},{id:"row_tbar",name:"Rudern Low Row",sets:3,reps:"6–10"},{id:"ohp",name:"Schulterdrücken",sets:3,reps:"6–10"},{id:"laterals",name:"Seitheben",sets:2,reps:"12–15"},{id:"facepull",name:"Face Pulls",sets:2,reps:"12–15"}],
  night_lower:[{id:"squat_press",name:"Kniebeugen/Beinpresse",sets:3,reps:"6–10"},{id:"rdl",name:"Gestrecktes KH",sets:3,reps:"6–10"},{id:"legext",name:"Beinstrecker",sets:2,reps:"12–15"},{id:"legcurl",name:"Beinbeuger",sets:2,reps:"12–15"},{id:"calf",name:"Wadenheben",sets:3,reps:"12–20"},{id:"abs",name:"Bauch",sets:2,reps:"12–15"}],
  free_push:[{id:"bb_flat",name:"Flachbankdrücken LH",sets:4,reps:"6–10"},{id:"db_incline",name:"Schrägbankdrücken KH",sets:4,reps:"6–10"},{id:"dips",name:"Dips",sets:3,reps:"8–12"},{id:"ohp_m",name:"Schulterdrücken",sets:3,reps:"8–12"},{id:"laterals_v",name:"Seitheben",sets:3,reps:"12–15"},{id:"revfly",name:"Reverse Flys",sets:3,reps:"12–15"},{id:"tri_push",name:"Trizepsdrücken",sets:3,reps:"8–12"}],
  free_pull:[{id:"pullup_w",name:"Klimmzüge breit",sets:4,reps:"6–10"},{id:"row_tbar2",name:"Rudern LH/T‑Bar",sets:4,reps:"6–10"},{id:"lat_narrow",name:"Latzug eng",sets:3,reps:"8–12"},{id:"rdl2",name:"Gestrecktes KH",sets:4,reps:"6–10"},{id:"shrugs",name:"Shrugs",sets:3,reps:"10–12"},{id:"bi_curls",name:"Bizepscurls",sets:3,reps:"8–12"},{id:"hammer",name:"Hammercurls",sets:3,reps:"8–12"}],
  free_legs:[{id:"squat_press2",name:"Kniebeugen/Beinpresse",sets:4,reps:"6–10"},{id:"front",name:"Frontkniebeugen",sets:3,reps:"8–12"},{id:"legext2",name:"Beinstrecker",sets:3,reps:"12–15"},{id:"rdl3",name:"Gestrecktes KH",sets:4,reps:"6–10"},{id:"legcurl2",name:"Beinbeuger",sets:3,reps:"12–15"},{id:"calf_stand",name:"Waden stehend",sets:4,reps:"12–20"},{id:"calf_sit",name:"Waden sitzend",sets:4,reps:"12–20"},{id:"abs2",name:"Bauch",sets:3,reps:"12–15"}]
};
const ADDONS=[{id:"cable_pullover",name:"Überzüge am Kabelzug"},{id:"rear_delt_cable",name:"Reverse Flys (Kabel)"},{id:"facepull_add",name:"Face Pulls"},{id:"preacher",name:"Scott‑Curls"},{id:"rope_crunch",name:"Cable Crunch"}];

const state = {
  logs: store.get("logs", []),
  lastSessions: store.get("lastSessions", {}),
  today: store.get("today", { date: fmtDate(), sessionId: null, exercises: [], addons: [] }),
};

$("#btnInstall").onclick = ()=>alert("iPhone: Teilen‑Symbol → 'Zum Home‑Bildschirm'. Danach offline nutzbar.");

function suggestNext(dateISO, night){
  const d = new Date(dateISO);
  const last = state.lastSessions;
  const hoursSince = k => last[k] ? (d - new Date(last[k]))/36e5 : 1e9;
  if(night){
    const lastNight = (new Date(last["night_upper"]||0) > new Date(last["night_lower"]||0)) ? "night_upper" : "night_lower";
    return lastNight==="night_upper" ? "night_lower" : "night_upper";
  }
  if (hoursSince("free_pull") > 72) return "free_pull";
  if (hoursSince("free_push") > 96) return "free_push";
  if (hoursSince("free_legs") > 96) return "free_legs";
  const order=["free_push","free_pull","free_legs"];
  const latest = order.reduce((a,k)=>Math.max(a, new Date(last[k]||0).getTime()), 0);
  const idx = (order.findIndex(k=>new Date(last[k]||0).getTime()===latest)+1)%order.length;
  return order[idx] || "free_push";
}

function renderSuggest(){
  const date=$("#datePick").value||fmtDate();
  const night=$("#nightShift").checked;
  const sess=suggestNext(date, night);
  const names={night_upper:"Nachtschicht – Oberkörper",night_lower:"Nachtschicht – Unterkörper",free_push:"Freie Tage – Push",free_pull:"Freie Tage – Pull",free_legs:"Freie Tage – Beine"};
  $("#suggestBox").innerHTML=`<span class="chip">Nächste empfohlene Einheit: <b>${names[sess]}</b></span>
  <button class="primary" id="btnApply">Übernehmen</button>`;
  $("#btnApply").onclick=()=>loadPlan(sess);
}
$("#btnSuggest").onclick=renderSuggest;
$("#datePick").value=state.today.date||fmtDate();

function exerciseRow(ex){
  let rows=[]; for(let i=1;i<=ex.sets;i++){ rows.push(`<input type="number" inputmode="decimal" placeholder="Wdh" class="rep" data-set="${i}" style="text-align:center">`); }
  return `<div class="exercise" data-id="${ex.id}">
    <h3>${ex.name} <span class="tag">${ex.sets}×${ex.reps}</span></h3>
    <div class="grid">${rows.join("")}</div>
    <div class="row" style="margin-top:8px; gap:8px">
      <input type="number" inputmode="decimal" placeholder="Gewicht (kg)" class="weight" style="min-width:120px">
      <textarea class="note" rows="2" placeholder="Notiz (optional) – z. B. Griff / Tempo / RPE"></textarea>
    </div>
  </div>`;
}

function loadPlan(sessionId){
  const list=PLANS[sessionId]||[];
  state.today={ date: $("#datePick").value||fmtDate(), sessionId, exercises:list.map(x=>({...x})), addons:[] };
  store.set("today", state.today);
  paintToday();
  state.lastSessions[sessionId]=new Date(state.today.date).toISOString();
  store.set("lastSessions", state.lastSessions);
}

function paintToday(){
  const box=$("#todayBox");
  if(!state.today.sessionId){ box.innerHTML='<div class="muted">Keine Einheit geladen.</div>'; return; }
  const names={night_upper:"Nachtschicht – Oberkörper",night_lower:"Nachtschicht – Unterkörper",free_push:"Freie Tage – Push",free_pull:"Freie Tage – Pull",free_legs:"Freie Tage – Beine"};
  let html=`<div class="row" style="align-items:center; justify-content:space-between">
    <div class="tag">${names[state.today.sessionId]}</div>
    <div class="muted">Datum: ${state.today.date}</div>
  </div>`;
  state.today.exercises.forEach(ex=>html+=exerciseRow(ex));
  state.today.addons.forEach(ex=>html+=exerciseRow(ex));
  box.innerHTML=html;
  $$("#todayBox .exercise").forEach(exEl=>{
    const id=exEl.dataset.id;
    exEl.oninput=()=>persistExerciseFromDOM(id, exEl);
  });
}

function persistExerciseFromDOM(id, el){
  const ex=(state.today.exercises.concat(state.today.addons)).find(e=>e.id===id); if(!ex) return;
  ex.weight=parseFloat($(".weight",el)?.value||"")||null;
  ex.reps_done=$$(".rep",el).map(r=>parseFloat(r.value||"")||null);
  ex.note=$(".note",el)?.value||"";
  store.set("today", state.today);
}

$("#btnLoadPlan").onclick=()=>{
  const night=$("#nightShift").checked;
  const sess=suggestNext($("#datePick").value||fmtDate(), night);
  loadPlan(sess);
};
$("#btnClear").onclick=()=>{
  state.today={ date: fmtDate(), sessionId:null, exercises:[], addons:[] };
  store.set("today", state.today); paintToday();
};

function buildAddonSelect(){ $("#addonSelect").innerHTML=ADDONS.map(a=>`<option value="${a.id}">${a.name}</option>`).join("") }
$("#btnAddOn").onclick=()=>{
  if(!state.today.sessionId){ alert("Bitte zuerst 'Plan laden'."); return; }
  if(state.today.addons.length>=2){ alert("Maximal 2 Add‑ons pro Tag."); return; }
  const id=$("#addonSelect").value; const meta=ADDONS.find(a=>a.id===id); if(!meta) return;
  state.today.addons.push({ id:id+"_"+Date.now(), name:meta.name, sets:3, reps:"12–15" });
  store.set("today", state.today); paintToday();
};
buildAddonSelect();

$("#btnExport").onclick=()=>{
  const rows=[["date","sessionId","exercise","weight","reps_array","note"]];
  const pack=(ex)=>({ weight: ex.weight??"", reps: JSON.stringify(ex.reps_done??[]), note: ex.note??"" });
  const pushRows=list=>list.forEach(ex=>rows.push([state.today.date, state.today.sessionId, ex.name, pack(ex).weight, pack(ex).reps, pack(ex).note]));
  pushRows(state.today.exercises); pushRows(state.today.addons);
  const csv=rows.map(r=>r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="training_logs.csv"; a.click();
};
$("#btnPaste").onclick=async()=>{
  const txt=prompt("Füge hier den Backup‑Text (JSON) ein:"); if(!txt) return;
  try{ const data=JSON.parse(txt); if(data.logs) state.logs=data.logs; if(data.lastSessions) state.lastSessions=data.lastSessions; if(data.today) state.today=data.today;
    store.set("logs",state.logs); store.set("lastSessions",state.lastSessions); store.set("today",state.today); alert("Backup importiert."); $("#datePick").value=state.today.date||fmtDate(); paintToday();
  }catch(e){ alert("Konnte nicht importieren: "+e.message) }
};

window.addEventListener("load", ()=>{ paintToday(); renderSuggest(); registerSW(); });
function registerSW(){ if("serviceWorker" in navigator){ navigator.serviceWorker.register("./service-worker.js").catch(()=>{}); } }
</script>
</body></html>
